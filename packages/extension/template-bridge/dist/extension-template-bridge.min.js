/*!
 * @cdp/extension-template-bridge 0.9.9
 *   extension for HTML templates bridge.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@cdp/extension-template")):"function"==typeof define&&define.amd?define(["exports","@cdp/extension-template"],t):(e="undefined"!=typeof globalThis?globalThis:e||self,t((e.CDP=e.CDP||{},e.CDP.Exension=e.CDP.Exension||{}),e.CDP.Exension))}(this,(function(e,t){"use strict";const r=e=>t=>n(t,e);function n(e,t){const r=[],n=[];let s=e,a=s.indexOf(t.delimiter.start);for(;a>=0;){if(s.indexOf(t.delimiter.end,a)<0)throw new Error(`missing end delimiter at: '${s}'`);r.push(s.substring(0,a));const e=i(s.substring(a+t.delimiter.start.length),t);if(e.insertionPoint)s=e.remainingTmplStr,n.push(e.insertionPoint),a=s.indexOf(t.delimiter.start);else{const n=r.pop();s=n+e.remainingTmplStr,a=s.indexOf(t.delimiter.start,n.length)}}return r.push(s),e=>t.html(r,...n.map((t=>t(e))))}function i(e,t){const r=Object.values(t.transformers).find((r=>r.test(e,t))),n=r?r.transform:t.transformVariable;return n(e,t)}function s(e,t){if("."===t)return e;let r=e;for(let e of t.split(".")){if(!r.hasOwnProperty(e))return"";r=r[e]}return r}function a(e,t){return function r(e){return null==e?"":""+e}(s(e,t))}const o=(e,{delimiter:t})=>{const r=e.indexOf(t.end),n=e.substring(0,r);return{remainingTmplStr:e.substring(r+t.end.length),insertionPoint:e=>a(e,n)}},h=e=>({test:e=>"{"===e[0],transform:(t,{delimiter:r})=>{const n=t.indexOf("}"+r.end);if(n<0)throw new Error(`missing end delimiter at: '${r.start}${t}'`);const i=t.substring(1,n);return{remainingTmplStr:t.substring(n+1+r.end.length),insertionPoint:t=>e(a(t,i))}}});function u(e){return[null,void 0,!1,0,NaN,""].some((t=>t===e))||e.length&&0===e.length}function d(e,t){const r=e.indexOf(t.end),n=e.substring(1,r),i=`${t.start}/${n}${t.end}`,s=e.indexOf(i);if(s<0)throw new Error(`missing end delimiter at: '${t.start}${e}'`);return{dataKey:n,innerTmpl:e.substring(r+t.start.length,s),remainingTmplStr:e.substring(s+i.length)}}const l=()=>({test:e=>"#"===e[0],transform:(e,t)=>{const r=d(e,t.delimiter),i=n(r.innerTmpl,t);return{remainingTmplStr:r.remainingTmplStr,insertionPoint:e=>{const t=s(e,r.dataKey);return u(t)?"":t.map?t.map((e=>i(e))):i(e)}}}}),c=()=>({test:e=>"^"===e[0],transform:(e,{delimiter:t})=>{const r=d(e,t);return{remainingTmplStr:r.remainingTmplStr,insertionPoint:e=>u(s(e,r.dataKey))?r.innerTmpl:""}}}),_=()=>({test:e=>"!"===e[0],transform:(e,{delimiter:t})=>({remainingTmplStr:e.substring(e.indexOf(t.end)+t.end.length),insertionPoint:void 0})}),p=()=>({test:e=>"="===e[0],transform:(e,t)=>{const r=t.delimiter.end.length,n=e.indexOf("="+t.delimiter.end);if(n<0)throw new Error(`missing end delimiter at: '${e}'`);const[i,s]=e.substring(1,n).split(" ");return t.delimiter.start=i,t.delimiter.end=s,{remainingTmplStr:e.substring(n+1+r),insertionPoint:void 0}}}),v=e=>t=>e(t instanceof HTMLTemplateElement?t.innerHTML:t);const f={variable:o,unsafeVariable:h,section:l,invertedSection:c,comment:_,customDelimiter:p},m=["this"],g=["+","-","!"],E=["+","-","*","/","%","^","==","!=",">","<",">=","<=","||","&&","??","&","===","!==","|","|>"],x={"!":0,":":0,",":0,")":0,"]":0,"}":0,"|>":1,"?":2,"??":3,"||":4,"&&":5,"|":6,"^":7,"&":8,"!=":9,"==":9,"!==":9,"===":9,">=":10,">":10,"<=":10,"<":10,"+":11,"-":11,"%":12,"/":12,"*":12,"(":13,"[":13,".":13,"{":13},O=["==","!=","<=",">=","||","&&","??","|>"],T=["===","!=="];var I;!function(e){e[e.STRING=1]="STRING",e[e.IDENTIFIER=2]="IDENTIFIER",e[e.DOT=3]="DOT",e[e.COMMA=4]="COMMA",e[e.COLON=5]="COLON",e[e.INTEGER=6]="INTEGER",e[e.DECIMAL=7]="DECIMAL",e[e.OPERATOR=8]="OPERATOR",e[e.GROUPER=9]="GROUPER",e[e.KEYWORD=10]="KEYWORD"}(I||(I={}));const y=(e,t,r=0)=>({kind:e,value:t,precedence:r}),k=e=>95===e||36===e||(e&=-33,65<=e&&e<=90),R=e=>48<=e&&e<=57;class w{constructor(e){this._index=-1,this._tokenStart=0,this._input=e,this._advance()}nextToken(){for(;e=this._next,9===e||10===e||13===e||32===e;)this._advance(!0);var e;if((e=>34===e||39===e)(this._next))return this._tokenizeString();if(k(this._next))return this._tokenizeIdentOrKeyword();if(R(this._next))return this._tokenizeNumber();if(46===this._next)return this._tokenizeDot();if(44===this._next)return this._tokenizeComma();if(58===this._next)return this._tokenizeColon();if((e=>43===e||45===e||42===e||47===e||33===e||38===e||37===e||60===e||61===e||62===e||63===e||94===e||124===e)(this._next))return this._tokenizeOperator();if((e=>40===e||41===e||91===e||93===e||123===e||125===e)(this._next))return this._tokenizeGrouper();if(this._advance(),void 0!==this._next)throw new Error(`Expected end of input, got ${this._next}`)}_advance(e){this._index++,this._index<this._input.length?(this._next=this._input.charCodeAt(this._index),!0===e&&(this._tokenStart=this._index)):this._next=void 0}_getValue(e=0){const t=this._input.substring(this._tokenStart,this._index+e);return 0===e&&this._clearValue(),t}_clearValue(){this._tokenStart=this._index}_tokenizeString(){const e="unterminated string",t=this._next;for(this._advance(!0);this._next!==t;){if(void 0===this._next)throw new Error(e);if(92===this._next&&(this._advance(),void 0===this._next))throw new Error(e);this._advance()}const r=y(I.STRING,(n=this._getValue(),n.replace(/\\(.)/g,((e,t)=>{switch(t){case"n":return"\n";case"r":return"\r";case"t":return"\t";case"b":return"\b";case"f":return"\f";default:return t}}))));var n;return this._advance(),r}_tokenizeIdentOrKeyword(){do{this._advance()}while(e=this._next,k(e)||R(e));var e;const t=this._getValue(),r=(n=t,-1!==m.indexOf(n)?I.KEYWORD:I.IDENTIFIER);var n;return y(r,t)}_tokenizeNumber(){do{this._advance()}while(R(this._next));return 46===this._next?this._tokenizeDot():y(I.INTEGER,this._getValue())}_tokenizeDot(){return this._advance(),R(this._next)?this._tokenizeFraction():(this._clearValue(),y(I.DOT,".",13))}_tokenizeComma(){return this._advance(!0),y(I.COMMA,",")}_tokenizeColon(){return this._advance(!0),y(I.COLON,":")}_tokenizeFraction(){do{this._advance()}while(R(this._next));return y(I.DECIMAL,this._getValue())}_tokenizeOperator(){this._advance();let e=this._getValue(2);return-1!==T.indexOf(e)?(this._advance(),this._advance()):(e=this._getValue(1),-1!==O.indexOf(e)&&this._advance()),e=this._getValue(),y(I.OPERATOR,e,x[e])}_tokenizeGrouper(){const e=String.fromCharCode(this._next),t=y(I.GROUPER,e,x[e]);return this._advance(!0),t}}const b=(e,t)=>new P(e,t).parse();class P{constructor(e,t){this._tokenizer=new w(e),this._ast=t}parse(){return this._advance(),this._parseExpression()}_advance(e,t){if(!this._matches(e,t))throw new Error(`Expected kind ${e} (${t}), was ${this._token}`);const r=this._tokenizer.nextToken();this._token=r,this._kind=null==r?void 0:r.kind,this._value=null==r?void 0:r.value}_matches(e,t){return!(e&&this._kind!==e||t&&this._value!==t)}_parseExpression(){if(!this._token)return this._ast.empty();const e=this._parseUnary();return void 0===e?void 0:this._parsePrecedence(e,0)}_parsePrecedence(e,t){if(void 0===e)throw new Error("Expected left to be defined.");for(;this._token;)if(this._matches(I.GROUPER,"(")){const t=this._parseArguments();e=this._ast.invoke(e,void 0,t)}else if(this._matches(I.GROUPER,"[")){const t=this._parseIndex();e=this._ast.index(e,t)}else if(this._matches(I.DOT)){this._advance();const t=this._parseUnary();e=this._makeInvokeOrGetter(e,t)}else{if(this._matches(I.KEYWORD))break;if(!(this._matches(I.OPERATOR)&&this._token.precedence>=t))break;e="?"===this._value?this._parseTernary(e):this._parseBinary(e,this._token)}return e}_makeInvokeOrGetter(e,t){if(void 0===t)throw new Error("expected identifier");if("ID"===t.type)return this._ast.getter(e,t.value);if("Invoke"===t.type&&"ID"===t.receiver.type){const r=t.receiver;return this._ast.invoke(e,r.value,t.arguments)}throw new Error(`expected identifier: ${t}`)}_parseBinary(e,t){if(-1===E.indexOf(t.value))throw new Error(`unknown operator: ${t.value}`);this._advance();let r=this._parseUnary();for(;(this._kind===I.OPERATOR||this._kind===I.DOT||this._kind===I.GROUPER)&&this._token.precedence>t.precedence;)r=this._parsePrecedence(r,this._token.precedence);return this._ast.binary(e,t.value,r)}_parseUnary(){if(this._matches(I.OPERATOR)){const e=this._value;if(this._advance(),"+"===e||"-"===e){if(this._matches(I.INTEGER))return this._parseInteger(e);if(this._matches(I.DECIMAL))return this._parseDecimal(e)}if(-1===g.indexOf(e))throw new Error(`unexpected token: ${e}`);const t=this._parsePrecedence(this._parsePrimary(),13);return this._ast.unary(e,t)}return this._parsePrimary()}_parseTernary(e){this._advance(I.OPERATOR,"?");const t=this._parseExpression();this._advance(I.COLON);const r=this._parseExpression();return this._ast.ternary(e,t,r)}_parsePrimary(){switch(this._kind){case I.KEYWORD:const e=this._value;if("this"===e)return this._advance(),this._ast.id(e);if(-1!==m.indexOf(e))throw new Error(`unexpected keyword: ${e}`);throw new Error(`unrecognized keyword: ${e}`);case I.IDENTIFIER:return this._parseInvokeOrIdentifier();case I.STRING:return this._parseString();case I.INTEGER:return this._parseInteger();case I.DECIMAL:return this._parseDecimal();case I.GROUPER:return"("===this._value?this._parseParen():"{"===this._value?this._parseMap():"["===this._value?this._parseList():void 0;case I.COLON:throw new Error('unexpected token ":"');default:return}}_parseList(){const e=[];do{if(this._advance(),this._matches(I.GROUPER,"]"))break;e.push(this._parseExpression())}while(this._matches(I.COMMA));return this._advance(I.GROUPER,"]"),this._ast.list(e)}_parseMap(){const e={};do{if(this._advance(),this._matches(I.GROUPER,"}"))break;const t=this._value;this._advance(I.STRING),this._advance(I.COLON),e[t]=this._parseExpression()}while(this._matches(I.COMMA));return this._advance(I.GROUPER,"}"),this._ast.map(e)}_parseInvokeOrIdentifier(){const e=this._value;if("true"===e)return this._advance(),this._ast.literal(!0);if("false"===e)return this._advance(),this._ast.literal(!1);if("null"===e)return this._advance(),this._ast.literal(null);if("undefined"===e)return this._advance(),this._ast.literal(void 0);const t=this._parseIdentifier(),r=this._parseArguments();return r?this._ast.invoke(t,void 0,r):t}_parseIdentifier(){if(!this._matches(I.IDENTIFIER))throw new Error(`expected identifier: ${this._value}`);const e=this._value;return this._advance(),this._ast.id(e)}_parseArguments(){if(!this._matches(I.GROUPER,"("))return;const e=[];do{if(this._advance(),this._matches(I.GROUPER,")"))break;const t=this._parseExpression();e.push(t)}while(this._matches(I.COMMA));return this._advance(I.GROUPER,")"),e}_parseIndex(){this._advance();const e=this._parseExpression();return this._advance(I.GROUPER,"]"),e}_parseParen(){this._advance();const e=this._parseExpression();return this._advance(I.GROUPER,")"),this._ast.paren(e)}_parseString(){const e=this._ast.literal(this._value);return this._advance(),e}_parseInteger(e=""){const t=this._ast.literal(parseInt(`${e}${this._value}`,10));return this._advance(),t}_parseDecimal(e=""){const t=this._ast.literal(parseFloat(`${e}${this._value}`));return this._advance(),t}}const N={"+":(e,t)=>e+t,"-":(e,t)=>e-t,"*":(e,t)=>e*t,"/":(e,t)=>e/t,"%":(e,t)=>e%t,"==":(e,t)=>e==t,"!=":(e,t)=>e!=t,"===":(e,t)=>e===t,"!==":(e,t)=>e!==t,">":(e,t)=>e>t,">=":(e,t)=>e>=t,"<":(e,t)=>e<t,"<=":(e,t)=>e<=t,"||":(e,t)=>e||t,"&&":(e,t)=>e&&t,"??":(e,t)=>null!=e?e:t,"|":(e,t)=>t(e),"|>":(e,t)=>t(e)},D={"+":e=>e,"-":e=>-e,"!":e=>!e};const{AttributePart:C,PropertyPart:S,BooleanAttributePart:M,EventPart:A}=t["_Σ"],G=new class ${empty(){return{type:"Empty",evaluate:e=>e,getIds:e=>e}}literal(e){return{type:"Literal",value:e,evaluate(e){return this.value},getIds:e=>e}}id(e){return{type:"ID",value:e,evaluate(e){return"this"===this.value?e:null==e?void 0:e[this.value]},getIds(e){return e.push(this.value),e}}}unary(e,t){const r=D[e];return{type:"Unary",operator:e,child:t,evaluate(e){return r(this.child.evaluate(e))},getIds(e){return this.child.getIds(e)}}}binary(e,t,r){const n=N[t];return{type:"Binary",operator:t,left:e,right:r,evaluate(e){return n(this.left.evaluate(e),this.right.evaluate(e))},getIds(e){return this.left.getIds(e),this.right.getIds(e),e}}}getter(e,t){return{type:"Getter",receiver:e,name:t,evaluate(e){var t;return null===(t=this.receiver.evaluate(e))||void 0===t?void 0:t[this.name]},getIds(e){return this.receiver.getIds(e),e}}}invoke(e,t,r){if(null!=t&&"string"!=typeof t)throw new Error("method not a string");return{type:"Invoke",receiver:e,method:t,arguments:r,evaluate(e){var r,n;const i=this.receiver.evaluate(e),s=this.method?i:null!==(r=e.this)&&void 0!==r?r:e,a=this.method?i[t]:i,o=null!==(n=this.arguments)&&void 0!==n?n:[],h=o.map((t=>null==t?void 0:t.evaluate(e)));return a.apply(s,h)},getIds(e){var t;return this.receiver.getIds(e),null===(t=this.arguments)||void 0===t||t.forEach((t=>null==t?void 0:t.getIds(e))),e}}}paren(e){return e}index(e,t){return{type:"Index",receiver:e,argument:t,evaluate(e){var t;return null===(t=this.receiver.evaluate(e))||void 0===t?void 0:t[this.argument.evaluate(e)]},getIds(e){return this.receiver.getIds(e),e}}}ternary(e,t,r){return{type:"Ternary",condition:e,trueExpr:t,falseExpr:r,evaluate(e){const t=this.condition.evaluate(e);return t?this.trueExpr.evaluate(e):this.falseExpr.evaluate(e)},getIds(e){return this.condition.getIds(e),this.trueExpr.getIds(e),this.falseExpr.getIds(e),e}}}map(e){return{type:"Map",entries:e,evaluate(t){const r={};if(e&&this.entries)for(const n in e){const e=this.entries[n];e&&(r[n]=e.evaluate(t))}return r},getIds(t){if(e&&this.entries)for(const r in e){const e=this.entries[r];e&&e.getIds(t)}return t}}}list(e){return{type:"List",items:e,evaluate(e){var t;return null===(t=this.items)||void 0===t?void 0:t.map((t=>null==t?void 0:t.evaluate(e)))},getIds(e){var t;return null===(t=this.items)||void 0===t?void 0:t.forEach((t=>null==t?void 0:t.getIds(e))),e}}}},z=new Map,L=e=>e.replace(/-(-|\w)/g,((e,t)=>t.toUpperCase())),U=(e,t)=>{let r=z.get(e);if(void 0===r){if(z.has(e))return;if(e=e.trim(),e.startsWith("{{")&&e.endsWith("}}")){const t=e.substring(2,e.length-2).trim();r=new P(t,G).parse(),z.set(e,r)}}return r?.evaluate(t)},V={if:(e,t,r,n)=>{const i=e.getAttribute("if");if(null!==i&&U(i,t))return W(e,t,r,n)},repeat:(e,r,n,i)=>{const s=e.getAttribute("repeat");if(null!==s){const a=U(s,r);if(!a[Symbol.iterator])return t.nothing;const o=B(e);let h=-1;const u=[];for(const e of a){h++;const t=Object.create(r);t.item=e,t.index=h,t.this=r.this??r;const s=o.parts.map((e=>e.update(t,n,i))),a={_$litType$:o,values:s};u.push(a)}return u}}},F=(e,t=V,r={},n)=>{const i=B(e),s=i.renderers;if(n){const t=B(n),i=t.renderers,a=s.super;void 0!==a?r={...s,...r,super:(e,t,r)=>(r={...i,...r,super:(e,t,r)=>W(n,e,t,r)},a(e,t,r))}:(r={...i,...s,...r},e=n)}else r={...r,...s};return n=>W(e,n,t,r)},W=(e,t,r=V,n={})=>{const i=B(e),s=[];for(const e of i.parts){const i=e.update(t,r,n);1===e.type?s.push(...i):s.push(i)}const a={_$litType$:i,values:s};return a},K=new Map,B=e=>{let t=K.get(e);return void 0===t&&K.set(e,t=H(e)),t},H=e=>{const t={h:void 0,el:e.cloneNode(!0),parts:[],renderers:{}},r=document.createTreeWalker(t.el.content,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT|NodeFilter.SHOW_COMMENT);let n=r.currentNode,i=-1;const s=[];for(;null!==(n=r.nextNode());)if(n.nodeType===Node.ELEMENT_NODE){i++;const e=n;if("TEMPLATE"===e.tagName){const r=e.getAttribute("type"),n=e.getAttribute("name");if(null!==r||null!==n){let a;e.parentNode.insertBefore(document.createComment(""),e),s.push(e),null!==r?a=(t,n,i)=>{const s=n[r];return s?.(e,t,n,i)}:("super"===n?t.renderers.super=(t,r,n)=>{const i=n.super,s=B(e);return n={...n,...s.renderers},i(t,r,n)}:t.renderers[n]=(t,r,n)=>W(e,t,r,n),a=(e,t,r)=>{const i=r[n];return i?.(e,t,r)}),t.parts.push({type:2,index:i,update:a})}}else{const r=e.getAttributeNames();for(const n of r){const r=e.getAttribute(n),s=r.split(/(?<!\\){{(.*?)(?:(?<!\\)}})/g);if(1===s.length)continue;e.removeAttribute(n);let a=n,o=C;const h=n[0];"."===h?(a=L(n.substring(1)),o=S):"?"===h?(a=n.substring(1),o=M):"@"===h&&(a=L(n.substring(1)),o=A);const u=[s[0]],d=[];for(let e=1;e<s.length;e+=2){const t=s[e];d.push(b(t,G)),u.push(s[e+1])}t.parts.push({type:1,index:i,name:a,strings:u,ctor:o,update:(e,t,r)=>d.map((t=>t.evaluate(e)))})}}}else if(n.nodeType===Node.TEXT_NODE){const e=n,s=e.textContent,a=s.split(/(?<!\\){{(.*?)(?:(?<!\\)}})/g);a.length>1?e.textContent=a[0].replace("\\{{","{{"):e.textContent=s.replace("\\{{","{{");for(let n=1;n<a.length;n+=2){const s=a[n],o=b(s,G);t.parts.push({type:2,index:++i,update:(e,t)=>o.evaluate(e)});const h=new Text(a[n+1].replace("\\{{","{{"));e.parentNode.insertBefore(h,e.nextSibling),e.parentNode.insertBefore(document.createComment(""),e.nextSibling),r.currentNode=h}}for(const e of s)e.remove();return t};e.createMustacheTransformer=function j(e,t){return v("function"==typeof e?(n=e,i=t,r({html:n,delimiter:{start:"{{",end:"}}"},transformVariable:o,transformers:{unsafeVariable:h(i),section:l(),invertedSection:c(),comment:{test:e=>"!"===e[0],transform:(e,{delimiter:t})=>({remainingTmplStr:e.substring(e.indexOf(t.end)+t.end.length),insertionPoint:void 0})},customDelimiterTransformer:p()}})):r(Object.assign({delimiter:{start:"{{",end:"}}"},transformers:{}},e)));var n,i},e.createStampinoTransformer=function Y(e){const{handlers:t,renderers:r,superTemplate:n}=e||{};return e=>F(function i(e){if(e instanceof HTMLTemplateElement)return e;if("string"==typeof e){const t=document.createElement("template");return t.innerHTML=e,t}throw new TypeError(`Type of template is not a valid. [typeof: ${typeof e}]`)}(e),t,r,n)},e.evaluateTemplate=W,e.prepareTemplate=F,e.transformer=f,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=extension-template-bridge.min.map